<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebGIS Provinsi Merge Union</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>


    <style>
        #map {
            height: 100vh;
            width: 100%;
        }

        .prov-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: white;
            font-size: 12px;
            pointer-events: none;
            text-shadow: 1px 1px 2px black;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }


        .lds-spinner,
        .lds-spinner div,
        .lds-spinner div:after {
            box-sizing: border-box;
        }

        .lds-spinner {
            color: currentColor;
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .lds-spinner div {
            transform-origin: 40px 40px;
            animation: lds-spinner 1.2s linear infinite;
        }

        .lds-spinner div:after {
            content: " ";
            display: block;
            position: absolute;
            top: 3.2px;
            left: 36.8px;
            width: 6.4px;
            height: 17.6px;
            border-radius: 20%;
            background: currentColor;
        }

        .lds-spinner div:nth-child(1) {
            transform: rotate(0deg);
            animation-delay: -1.1s;
        }

        .lds-spinner div:nth-child(2) {
            transform: rotate(30deg);
            animation-delay: -1s;
        }

        .lds-spinner div:nth-child(3) {
            transform: rotate(60deg);
            animation-delay: -0.9s;
        }

        .lds-spinner div:nth-child(4) {
            transform: rotate(90deg);
            animation-delay: -0.8s;
        }

        .lds-spinner div:nth-child(5) {
            transform: rotate(120deg);
            animation-delay: -0.7s;
        }

        .lds-spinner div:nth-child(6) {
            transform: rotate(150deg);
            animation-delay: -0.6s;
        }

        .lds-spinner div:nth-child(7) {
            transform: rotate(180deg);
            animation-delay: -0.5s;
        }

        .lds-spinner div:nth-child(8) {
            transform: rotate(210deg);
            animation-delay: -0.4s;
        }

        .lds-spinner div:nth-child(9) {
            transform: rotate(240deg);
            animation-delay: -0.3s;
        }

        .lds-spinner div:nth-child(10) {
            transform: rotate(270deg);
            animation-delay: -0.2s;
        }

        .lds-spinner div:nth-child(11) {
            transform: rotate(300deg);
            animation-delay: -0.1s;
        }

        .lds-spinner div:nth-child(12) {
            transform: rotate(330deg);
            animation-delay: 0s;
        }

        @keyframes lds-spinner {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="lds-spinner">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        Memuat peta dan fitur-fitur...
    </div>

    <div id="map"></div>

    <script>

        // Memuat data CSV
        let provDataMap = {}; // map dari idProv â†’ data CSV

        async function loadCSVData() {
            return new Promise((resolve, reject) => {
                Papa.parse("data/data SEM.csv", {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    complete: function (results) {
                        results.data.forEach(row => {
                            provDataMap[row.idProv] = row;
                        });
                        resolve();
                    },
                    error: function (err) {
                        reject(err);
                    }
                });
            });
        }

        function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

        showLoading();

        // === Map & Basemap ===
        const map = L.map("map").setView([-2.5, 118], 5);
        L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a> | &copy; <a href="https://openstreetmap.org">OpenStreetMap</a>'
        }).addTo(map);

        map.createPane("rasterPane").style.zIndex = 200;
        map.createPane("vectorPane").style.zIndex = 400;
        map.createPane("kabPane").style.zIndex = 500;

        // === Raster ===
        async function loadRaster() {
            const res = await fetch("data/NTL.tif");
            const arrayBuffer = await res.arrayBuffer();
            const georaster = await parseGeoraster(arrayBuffer);
            const rasterLayer = new GeoRasterLayer({
                georaster,
                pane: "rasterPane",
                opacity: 1,
                resolution: 256,
                pixelValuesToColorFn: value => {
                    if (value <= 0) return null;
                    const min = 0, max = 15;
                    const ratio = Math.min((value - min) / (max - min), 1);
                    const r = Math.floor(255 * ratio);
                    const g = Math.floor(255 * (1 - ratio));
                    return `rgba(${r},${g},0,${ratio})`;
                }
            });
            rasterLayer.addTo(map);
        }

        const provCodes = [11, 12, 13, 14, 15, 16, 17, 18, 19, 21, 31, 32, 33, 34, 35, 36, 51, 52, 53, 61, 62, 63, 64, 65, 71, 72, 73, 74, 75, 76, 81, 82, 91, 92, 93, 94, 95, 96];
        const kabCodes = [1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208, 1209, 1210, 1211, 1212, 1213, 1214, 1215, 1216, 1217, 1218, 1219, 1220, 1221, 1222, 1223, 1224, 1225, 1271, 1272, 1273, 1274, 1275, 1276, 1277, 1278];

        const cacheProv = {}, cacheKab = {};

        async function fetchProvGeoJSON(code) {
            if (cacheProv[code]) return cacheProv[code];
            try {
                const res = await fetch(`https://whatsproject.my.id/geo/v1/prov/${code}/map`);
                const json = await res.json();
                const geo = json.provFeature?.provFeature || json.provFeature || json;
                if (geo && geo.type === "FeatureCollection") {
                    cacheProv[code] = { code, geo };
                    return cacheProv[code];
                }
                return null;
            } catch (e) { console.warn(`Gagal memuat provinsi ${code}`, e); return null; }
        }

        async function fetchKabGeoJSON(code) {
            if (cacheKab[code]) return cacheKab[code];
            try {
                const res = await fetch(`https://whatsproject.my.id/geo/v1/city/${code}/map`);
                const json = await res.json();
                const geo = json.cityFeature?.cityFeature || json.cityFeature || json;
                if (geo && geo.type === "FeatureCollection") {
                    cacheKab[code] = { code, geo };
                    return cacheKab[code];
                }
                return null;
            } catch (e) { console.warn(`Gagal memuat kabupaten ${code}`, e); return null; }
        }

        // === Merge & Union Provinsi ===
        const mergeProvCodes = { 92: [92, 96], 91: [91, 93, 94, 95] };

        async function mergeProvincesUnion(codes) {
            const merged = {};
            for (const code of codes) {
                const prov = await fetchProvGeoJSON(code);
                if (!prov) continue;
                let target = code;
                for (const key in mergeProvCodes) {
                    if (mergeProvCodes[key].includes(code)) target = parseInt(key);
                }
                prov.geo.features.forEach(f => {
                    if (!merged[target]) merged[target] = f;
                    else merged[target] = turf.union(merged[target], f);
                });
            }
            return Object.entries(merged).map(([code, feature]) => ({
                code: parseInt(code),
                geo: { type: "FeatureCollection", features: [feature] }
            }));
        }

        const kabLayerGroup = L.layerGroup().addTo(map);
        let provTooltips = [];

        function addProvinceLayer({ code, geo }) {
            const defaultStyle = { color: '#00bfff', weight: 1, fillOpacity: 0 };
            const highlightStyle = { color: '#ffff00', weight: 3, fillOpacity: 0.2 };

            const bounds = L.geoJSON(geo).getBounds();
            const center = bounds.getCenter();

            const layer = L.geoJSON(geo, { pane: "vectorPane", style: defaultStyle }).addTo(map);

            // Ambil data CSV
            const csvData = provDataMap[code];
            const nama = geo.features[0].properties?.Name || `Provinsi ${code}`;
            const popupContent = csvData
                ? `<b>${nama}</b><br>PDRB ADHK: ${csvData.pdrbadhk24_M}<br>jumlah koperasi: ${csvData.koperasi}<br>jumlah BPR/BPRS: ${csvData["BPR/S"]}<br>Indeks Penetrasi Internet: ${csvData["PENETRASI"]}`
                : `<b>${nama}</b><br>Data CSV tidak tersedia`;

            layer.bindPopup(popupContent);

            const tooltip = L.tooltip({ permanent: true, direction: "center", className: "prov-label" })
                .setContent(nama)
                .setLatLng(center);
            provTooltips.push(tooltip);
            map.addLayer(tooltip);

            layer.on("mouseover", () => layer.setStyle(highlightStyle));
            layer.on("mouseout", () => layer.setStyle(defaultStyle));



            layer.on("dblclick", async (e) => {
                L.DomEvent.stopPropagation(e); L.DomEvent.preventDefault(e);
                map.fitBounds(layer.getBounds(), { padding: [20, 20], maxZoom: 9 });
                kabLayerGroup.clearLayers();
                showLoading();
                const kabResults = await Promise.all(kabCodes.map(fetchKabGeoJSON));
                kabResults.filter(r => r).forEach(({ code, geo }) => {
                    L.geoJSON(geo, {
                        pane: "kabPane",
                        style: { color: "#ff6600", weight: 1, fillOpacity: 0 },
                        onEachFeature: (f, l) => {
                            const nama = f.properties?.Name || `Kabupaten ${code}`;
                            l.bindPopup(`<b>${nama}</b><br>Kode: ${f.properties.Code}`);
                            l.bindTooltip(nama, { permanent: false, direction: "top", className: "prov-label" });
                            l.on("mouseover", () => l.setStyle({ color: "#ffff00", weight: 3 }));
                            l.on("mouseout", () => l.setStyle({ color: "#ff6600", weight: 1 }));
                        }
                    }).addTo(kabLayerGroup);
                });
                hideLoading();
            });
        }

        function updateTooltipVisibility() {
            const zoom = map.getZoom();
            provTooltips.forEach(t => {
                const pos = map.latLngToContainerPoint(t.getLatLng());
                const isInViewport = pos.x > 0 && pos.y > 0 && pos.x < window.innerWidth && pos.y < window.innerHeight;
                if (zoom < 6 || !isInViewport) map.removeLayer(t);
                else if (!map.hasLayer(t)) map.addLayer(t);
            });
        }

        map.on("moveend zoomend", updateTooltipVisibility);
        map.on("zoomend", () => { if (map.getZoom() < 8) kabLayerGroup.clearLayers(); updateTooltipVisibility(); });

        // === Jalankan semua ===
        (async function () {
            showLoading();
            await loadRaster();
            await loadCSVData();          // <--- load CSV dulu
            const mergedProv = await mergeProvincesUnion(provCodes);
            mergedProv.forEach(addProvinceLayer);
            hideLoading();
        })();

    </script>
</body>

</html>